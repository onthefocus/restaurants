<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.16/dist/tailwind.min.css" rel="stylesheet">
    <title>Restaurant Details</title>
</head>

<body class="bg-gray-100">
    <!-- Success Indicator -->
    <div id="success-modal" class="fixed z-10 hidden inset-0 bg-black bg-opacity-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded shadow-md">
            <span class="text-green-500">âœ“ Value Recorded Successfully</span>
        </div>
    </div>
    <div id="remove-device-modal"
        class="fixed z-10 hidden inset-0 bg-black bg-opacity-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded shadow-md">
            <h2 class="text-xl font-bold mb-4">Remove Device</h2>
            <ul id="remove-device-list" class="space-y-2 mb-4">
                <!-- Device list items will be added dynamically -->
            </ul>
            <button id="close-remove-modal" class="bg-red-500 text-white px-4 py-2 rounded">Close</button>
        </div>
    </div>

    <div class="container mx-auto py-10">

        <div class="bg-white rounded-lg p-6 shadow-md">
            <!-- First Part -->
            <div class="mb-6">
                <div class="mb-2">
                    <span id="network-name" class="font-medium text-2xl"></span>
                </div>
                <div>
                    <span id="location" class="font-medium text-xl"></span>
                </div>
                <hr class="border-gray-300 mt-6">
            </div>

            <p class="text-left text-xl ">Available Devices</p>
            <div class="flex  mb-4 items-center mt-2">

                <a id="add-modal" class=" text-blue-500 mr-2 cursor-pointer">Add New</a>
               
            </div>



            <!-- Second Part: Multi Modal -->
            <template id="device-modal-template">

                <!-- Device Modal -->
                <div class="bg-gray-100 rounded-lg p-6 shadow-md my-5">
                    <div class="flex justify-between mb-4">
                        <div class="flex flex-col space-y-3">
                            <span class="font-semibold mr-2">Device Name:</span>
                            <input id="location-name" type="text" class="border border-gray-300 rounded-md p-2"
                                value="">
                                <a id="remove-modal" class="text-red-500 cursor-pointer">Remove Device</a>
                             <div class="flex items-center">  
                                <label class="font-semibold mr-2">Last Replacement:</label>
                                <div id="last-replacement" class="font-normal">(not replaced)</div>
                            </div>
                            <div>
                                <button id="replace"
                                    class="bg-blue-500 text-white rounded-md px-5 py-2">Replace</button>
                            </div>
                            
                               
                        </div>
                        <div class="flex flex-col space-y-3">
                            <div class="flex justify-between items-center">
                                <label for="time" class="font-semibold mr-2">Date & Time:</label>
                                <input id="time" type="text" class="border border-gray-300 rounded-md p-2">
                            </div>
                            <div class="flex justify-between items-center">
                                <label for="value" class="font-semibold mr-2">Value:</label>
                                <input id="value" type="text" class="border border-gray-300 rounded-md p-2">

                            </div>
                            <div class="text-right">
                              <button id="record" class="bg-green-500 text-white px-4 py-2 rounded">Record Value</button>
                            </div>
                        </div>



                    </div>


                </div>
                <!-- /Device Modal -->

            </template>
        </div>
    </div>

    <script>
        function getParameterByName(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        const restaurantId = parseInt(getParameterByName('restaurantId'));
        let restaurant = null;

        // Fetch all restaurants data
        fetch('https://api.restaurants.provocati.lt/api/restaurants')
            .then(response => response.json())
            .then(restaurants => {
                // Find the specific restaurant
                restaurant = restaurants.find(r => r.id === parseInt(restaurantId));

                if (restaurant) {
                    // Fetch all networks data
                    return fetch('https://api.restaurants.provocati.lt/api/networks');
                } else {
                    throw new Error('Restaurant not found');
                }
            })
            .then(response => response.json())
            .then(networks => {
                // Find the specific network
                const restaurantNetwork = networks.find(n => n.id === parseInt(restaurant.network_id));

                if (restaurantNetwork) {
                    document.getElementById('network-name').textContent = restaurantNetwork.name;
                    document.getElementById('location').textContent = restaurant.name;
                } else {
                    throw new Error('Network not found');
                }
            })
            .catch(error => console.error(error));

        function getDateTime() {
            const now = new Date();
            const date = now.toLocaleDateString('en-US');
            const time = now.toLocaleTimeString('en-US', { hour12: false });
            return `${date} ${time}`;
        }

        document.getElementById('add-modal').addEventListener('click', function (event) {
            const isNew = event && event.detail;

            const template = document.getElementById('device-modal-template');
            const clone = template.content.cloneNode(true);
            const container = document.querySelector('.container .bg-white');
            container.appendChild(clone);

            const timeInput = container.lastElementChild.querySelector('#time');
            timeInput.value = getDateTime();

            container.lastElementChild.querySelector('#replace').addEventListener('click', function () {
                const locationName = container.lastElementChild.querySelector('#location-name').value;
                const deviceId = this.closest('.space-y-6').getAttribute('data-device-id');
                // Send a POST request to replace the device with the matching location name
                fetch(`https://api.restaurants.provocati.lt/api/devices/${deviceId}/replace`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },

                })
                    .then(response => {
                        if (response.ok) {
                            const successModal = document.getElementById('success-modal');
                            successModal.classList.remove('hidden');
                            setTimeout(() => successModal.classList.add('hidden'), 2000);

                            // Hide the "Save" button
                            const saveButton = this.parentElement.querySelector('#save');
                            if (saveButton) {
                                saveButton.style.display = 'none';
                            }
                        } else {
                            throw new Error('Failed to replace device');
                        }
                    })
                    .catch(error => console.error(error));

                // Update the "Last Replacement" time
                const lastReplacement = this.parentElement.parentElement.querySelector('#last-replacement');
                lastReplacement.textContent = getDateTime();
            });

            container.lastElementChild.querySelector('#record').addEventListener('click', function () {
                const deviceId = this.closest('.space-y-6').getAttribute('data-device-id');
                const value = this.parentElement.parentElement.querySelector('#value').value;
                const time = this.parentElement.parentElement.querySelector('#time').value;

                if (value && time) {
                    // Send a GET request to record the value
                    fetch(`https://api.restaurants.provocati.lt/api/devices/${deviceId}/value/${value}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                        .then(response => {
                            if (response.ok) {
                                const successModal = document.getElementById('success-modal');
                                successModal.classList.remove('hidden');
                                setTimeout(() => successModal.classList.add('hidden'), 2000);
                            } else {
                                throw new Error('Failed to record value');
                            }
                        })
                        .catch(error => console.error(error));
                } else {
                    alert('Please enter both time and value before recording.');
                }
            });

            if (isNew) {
                // Add a "Save" button to save the new device to the API
                const saveButton = document.createElement('button');
                saveButton.id = 'save';
                saveButton.innerText = 'Save';
                saveButton.classList.add('bg-green-500', 'text-white', 'px-4', 'py-2', 'rounded', 'ml-2');
                saveButton.addEventListener('click', async function () {
                    updateRemoveDeviceList();
                    const locationName = container.lastElementChild.querySelector('#location-name').value;

                    fetch('https://api.restaurants.provocati.lt/api/devices', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name: locationName,
                            restaurant_id: restaurantId
                        })
                    })
                        .then(response => {
                            if (response.ok) {
                                return response.json(); // Add this line to get the JSON response
                            } else {
                                throw new Error('Failed to add device');
                            }
                        })
                        .then(device => { // Add this block to handle the JSON response
                            const successModal = document.getElementById('success-modal');
                            successModal.classList.remove('hidden');
                            setTimeout(() => successModal.classList.add('hidden'), 2000);

                            // Hide the "Save" button
                            saveButton.style.display = 'none';

                            const deviceElement = this.closest('.space-y-6');
                            // Update the data-device-id attribute with the new device ID
                            deviceElement.setAttribute('data-device-id', device.id);
                        })
                        .catch(error => console.error(error));
                });

                const locationNameInput = container.lastElementChild.querySelector('#location-name');
                locationNameInput.insertAdjacentElement('afterend', saveButton);
            }
        });

        updateRemoveDeviceList();

        async function fetchDevices(restaurantId) {
            const response = await fetch('https://api.restaurants.provocati.lt/api/devices');
            const devices = await response.json();


            const filteredDevices = devices.filter(device => device.restaurant_id === restaurantId);

            filteredDevices.forEach(device => {


                const deviceId = device.id;
                // Add a new device
                const addModalButton = document.getElementById('add-modal');
                addModalButton.dispatchEvent(new CustomEvent('click', { detail: false }));

                // Set the name of the newly added device
                const container = document.querySelector('.container .bg-white');
                const deviceElement = container.lastElementChild;
                deviceElement.querySelector('#location-name').value = device.name;
                deviceElement.setAttribute('data-device-id', deviceId);

                getLastReplacementDate(deviceId)
                    .then(date => {
                        if (date) {
                            deviceElement.querySelector('#last-replacement').textContent = date;
                        }
                    })
                    .catch(error => console.error(error));
            });
        }

        fetchDevices(restaurantId);

        async function getLastReplacementDate(deviceId) {
            const response = await fetch(`https://api.restaurants.provocati.lt/api/devices/${deviceId}`);
            const deviceData = await response.json();

            const lastReplacement = deviceData.replacements.slice(-1)[0];
            if (lastReplacement) {
                const date = new Date(lastReplacement.updated_at);
                const options = {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: 'numeric',
                    minute: 'numeric',
                    second: 'numeric'
                };
                return date.toLocaleString('en-US', options);
            } else {
                return null;
            }
        }

        async function updateRemoveDeviceList() {
            const removeList = document.getElementById('remove-list');
            removeList.innerHTML = '';

            const devices = await fetchDevices(restaurantId);

            devices.forEach(device => {
                const deviceItem = document.createElement('div');
                deviceItem.classList.add('flex', 'justify-between', 'items-center', 'mb-2');

                const deviceName = document.createElement('span');
                deviceName.textContent = device.name;
                deviceItem.appendChild(deviceName);

                const removeButton = document.createElement('button');
                removeButton.classList.add('bg-red-500', 'text-white', 'px-4', 'py-2', 'rounded');
                removeButton.textContent = 'Remove';
                removeButton.addEventListener('click', async () => {
                    await fetch(`https://api.restaurants.provocati.lt/api/devices/${device.id}/delete`, { method: 'GET' });

                    await updateRemoveDeviceList();
                });

                deviceItem.appendChild(removeButton);
                removeList.appendChild(deviceItem);
            });

            // Add this line to ensure the device list is properly updated after deleting the last element
            return devices;
        }

        document.getElementById('remove-modal').addEventListener('click', function () {
            const removeDeviceModal = document.getElementById('remove-device-modal');
            removeDeviceModal.classList.remove('hidden');

            // Populate the list of devices in the remove device modal
            const removeDeviceList = document.getElementById('remove-device-list');
            removeDeviceList.innerHTML = '';

            const deviceElements = document.querySelectorAll('.space-y-6');
            deviceElements.forEach((deviceElement, index) => {
                const locationName = deviceElement.querySelector('#location-name').value;
                const deviceId = deviceElement.getAttribute('data-device-id');

                const listItem = document.createElement('li');
                listItem.classList.add('flex', 'justify-between', 'items-center');

                const deviceName = document.createElement('span');
                deviceName.textContent = locationName;
                listItem.appendChild(deviceName);

                const removeButton = document.createElement('button');
                removeButton.textContent = 'Remove';
                removeButton.classList.add('bg-red-500', 'text-white', 'px-4', 'py-2', 'rounded');
                removeButton.addEventListener('click', async () => {
                    // Send a GET request to delete the device from the backend
                    fetch(`https://api.restaurants.provocati.lt/api/devices/${deviceId}/delete`, {
                        method: 'GET',
                    })
                        .then(response => {
                            if (response.ok) {
                                deviceElement.remove();
                                listItem.remove();
                            } else {
                                throw new Error('Failed to delete device');
                            }
                        })
                        .catch(error => console.error(error));
                });
                listItem.appendChild(removeButton);

                removeDeviceList.appendChild(listItem);
            });
        });

        // Function to close the remove device modal
        document.getElementById('close-remove-modal').addEventListener('click', function () {
            const removeDeviceModal = document.getElementById('remove-device-modal');
            removeDeviceModal.classList.add('hidden');
        });

    </script>
</body>

</html>